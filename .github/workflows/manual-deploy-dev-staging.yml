name: Manual Deploy (Dev/Staging)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - dev
          - staging
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - plan
          - apply
          - destroy
        default: 'plan'
      auto_approve:
        description: 'Auto approve apply/destroy operations'
        required: false
        type: boolean
        default: false

jobs:
  build:
    uses: ./.github/workflows/terragrunt.yml
    with:
      module_path: lambda-build-module
      environment: ${{ github.event.inputs.environment }}
      action: ${{ github.event.inputs.action }}
      auto_approve: ${{ github.event.inputs.auto_approve }}
      aws_region: eu-west-1
    secrets: inherit
    
  build-apply:
    needs: build
    if: github.event.inputs.action == 'apply' && needs.build.result == 'success'
    uses: ./.github/workflows/terragrunt.yml
    with:
      module_path: lambda-build-module
      environment: ${{ github.event.inputs.environment }}
      action: apply
      auto_approve: true
      aws_region: eu-west-1
    secrets: inherit
    
  deploy:
    needs: [build, build-apply]
    if: |
      (github.event.inputs.action == 'plan' && needs.build.result == 'success') ||
      (github.event.inputs.action == 'apply' && needs.build-apply.result == 'success')
    uses: ./.github/workflows/terragrunt.yml
    with:
      module_path: lambda-deploy-module
      environment: ${{ github.event.inputs.environment }}
      action: ${{ github.event.inputs.action }}
      auto_approve: ${{ github.event.inputs.auto_approve }}
      aws_region: eu-west-1
    secrets: inherit 